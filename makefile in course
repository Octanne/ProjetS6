
#TODO voir pour auto la génération des dépendances check l'autre script.

EXEC = Client/client Editeur/editeur# EDIT THIS LINE

BIN_DIR = bin# DONT TOUCH
OBJECTS_DIR = obj# DONT TOUCH

INCLUDES = includes/ Client/includes/ Editeur/includes/ Serveur/includes/# EDIT THIS LINE
OBJECTS_CLI = obj/level_update.o obj/client_gui.o obj/client.o# EDIT THIS LINE
OBJECTS_EDIT = obj/level_edit.o obj/editor_gui.o obj/system_save.o obj/editeur.o# EDIT THIS LINE
OBJECTS_GEN = obj/level.o obj/liste.o obj/objet.o obj/utils.o# EDIT THIS LINE
include_dirs = $(wildcard $(addsuffix */, $(INCLUDES)))# DONT TOUCH
INCLUDE_STD = $(addprefix -iquote ,$(INCLUDES) $(include_dirs))# DONT TOUCH

CC = gcc
CCFLAGS_STD = -Wall -O3
CCFLAGS_DEBUG = -D _DEBUG_
CCFLAGS = $(CCFLAGS_STD)
CCLIBS = -lncurses -lpthread
LD = gcc -Wall -o

# Ajouter la différentiation des fichiers objets des différents exécutables créer un fichier pour chaque exécutable
# Voir plutard pour que les listes soit mise à jour de la même manière que les dépendances

#
# RULES (must not change it)
#

all: prepare buildobj loadobj
	@echo "Create executables..."
	@echo "Executable CLI :"; \
	echo "$(LD) $$exec_name bin/client $(OBJECTS_GEN) $(OBJECTS_CLI) $(CCLIBS);"; \
	$(LD) $$exec_name bin/client $(OBJECTS) $(OBJECTS_CLI) $(CCLIBS); \
	
	@echo "Executable EDITEUR :"; \
	echo "$(LD) $$exec_name bin/editeur $(OBJECTS_GEN) $(OBJECTS_EDIT) $(CCLIBS);"; \
	$(LD) $$exec_name bin/editeur $(OBJECTS_GEN) $(OBJECTS_EDIT) $(CCLIBS); \
	@echo "Done."

prepare:
	@echo "Create objects..."
	@mkdir -p $(OBJECTS_DIR)
	@mkdir -p $(BIN_DIR)
	
debug: CCFLAGS = $(CCFLAGS_STD) $(CCFLAGS_DEBUG)
debug: all

#
# MAIN RULES (must not change it)
#

# You can add your own commands
clean:
	@echo "Delete objects, temporary files..."
	@rm -f obj/*.o
	@rm -f bin/*
	@rm -f obj/objects.temp
	@rm -f dependancies
	@echo "Done."

depend: updateobj
	@echo "Create dependancies..."
	@sed -e "/^# DEPENDANCIES/,$$ d" makefile > dependancies
	@echo "# DEPENDANCIES" >> dependancies

	@echo "EXEC : $(EXEC)"
	@for i in $(EXEC); do \
	o_name=$(OBJECTS_DIR)/`echo $$i | sed "s/\(.*\)\/\(.*\)$$/\2.o/"`; \
	echo "Create dependancies for $$o_name & $$i..."; \
	$(CC) -MM -MT $$o_name $(CCFLAGS) $(INCLUDE_STD) $$i.c >> dependancies; \
	echo "	@echo \"Create $$o_name...\"" >> dependancies; \
	echo "	@$(CC) $(CCFLAGS) $(INCLUDE_STD) -c $$i.c -o $$o_name" >> dependancies; \
	done

	@echo "Includes : $(INCLUDES)";
	@for FOLDER in $(INCLUDES); do \
	echo "Folder : $$FOLDER"; \
	files_c=`find $$FOLDER -mindepth 1 -maxdepth 1 -type d`; \
	for i in $$files_c; do \
	#o_name=$$i/`echo $$i | sed "s/\(.*\)\/\(.*\)$$/\2.o/"`; \
	o_name=$(OBJECTS_DIR)/`echo $$i | sed "s/\(.*\)\/\(.*\)$$/\2.o/"`; \
	c_name=$$i/`echo $$i | sed "s/\(.*\)\/\(.*\)$$/\2.c/"`; \
	echo "  Generating rule for $$o_name..."; \
	$(CC) -MM -MT $$o_name $(CCFLAGS) $(INCLUDE_STD) $$c_name >> dependancies; \
	echo "	@echo \"Create $$o_name...\"" >> dependancies; \
	echo "	@$(CC) $(CCFLAGS) $(INCLUDE_STD) -c $$c_name -o $$o_name" >> dependancies; \
	done; \
	done;

	@echo "buildobj: $(OBJECTS) $(EXEC_O)";
	@echo "buildobj: $(OBJECTS) $(EXEC_O)" >> dependancies;
	@echo "	@echo \"Build objects done\"" >> dependancies;
	
	@cat dependancies > makefile
	@rm dependancies
	@echo "Done"

getobj:
	@echo "Get objects list..."
	@rm -f $(OBJECTS_DIR)/objects.tmp
	@touch $(OBJECTS_DIR)/objects.tmp

	@rm -f $(OBJECTS_DIR)/execs.tmp
	@touch $(OBJECTS_DIR)/execs.tmp

	@for FOLDER in $(INCLUDES); do \
	files_c=`find $$FOLDER -mindepth 1 -maxdepth 1 -type d`; \
	for i in $$files_c; do \
	o_name=$(OBJECTS_DIR)/`echo $$i | sed "s/\(.*\)\/\(.*\)$$/\2.o/"`; \
	echo "$$o_name" >> $(OBJECTS_DIR)/objects.tmp; \
	done; \
	done

	@for EXEC in $(EXEC); do \
	o_name=$(OBJECTS_DIR)/`echo $$EXEC | sed "s/\(.*\)\/\(.*\)$$/\2.o/"`; \
	echo "$$o_name" >> $(OBJECTS_DIR)/execs.tmp; \
	done

updateobj: getobj
	@echo "Update objects/execs..."
	$(eval OBJECTS := $(shell cat $(OBJECTS_DIR)/objects.tmp))
	$(eval EXEC_O := $(shell cat $(OBJECTS_DIR)/execs.tmp))
	@echo "Objects : $(OBJECTS)"
	@echo "Execs : $(EXEC_O)"

loadobj:
	@echo "Load objects/execs list..."
	$(eval OBJECTS := $(shell cat $(OBJECTS_DIR)/objects.tmp))
	$(eval EXEC_O := $(shell cat $(OBJECTS_DIR)/execs.tmp))
	@echo "Objects : $(OBJECTS)"
	@echo "Execs : $(EXEC_O)"



# | sed ':a;N;$!ba;s/\n/ /g'
# #$(CC) -MM -MT $(addprefix $(OBJECTS_DIR)/,$$i) $(CCFLAGS) $(SRC_DIR)/`echo $$i | sed "s/\(.*\)\\.o$$/\1.c/"` -I$(INCLUDE_DIR) >> dependancies; \
# DEPENDANCIES
obj/client.o: Client/client.c includes/level/level.h \
 includes/liste/liste.h includes/objet/objet.h includes/utils/utils.h \
 includes/utils/constants.h includes/utils/st_benchmark.h \
 Client/includes/level_update/level_update.h \
 Client/includes/client_gui/client_gui.h
	@echo "Create obj/client.o..."
	@gcc -Wall -O3 -iquote includes/ -iquote Client/includes/ -iquote Editeur/includes/ -iquote Serveur/includes/ -iquote includes/level/ -iquote includes/liste/ -iquote includes/objet/ -iquote includes/utils/ -iquote Client/includes/client_gui/ -iquote Client/includes/level_update/ -iquote Editeur/includes/editor_gui/ -iquote Editeur/includes/level_edit/ -iquote Editeur/includes/system_save/ -c Client/client.c -o obj/client.o
obj/editeur.o: Editeur/editeur.c includes/level/level.h \
 includes/liste/liste.h includes/objet/objet.h includes/utils/utils.h \
 includes/utils/constants.h includes/utils/st_benchmark.h \
 Editeur/includes/level_edit/level_edit.h \
 Editeur/includes/system_save/system_save.h \
 Editeur/includes/editor_gui/editor_gui.h
	@echo "Create obj/editeur.o..."
	@gcc -Wall -O3 -iquote includes/ -iquote Client/includes/ -iquote Editeur/includes/ -iquote Serveur/includes/ -iquote includes/level/ -iquote includes/liste/ -iquote includes/objet/ -iquote includes/utils/ -iquote Client/includes/client_gui/ -iquote Client/includes/level_update/ -iquote Editeur/includes/editor_gui/ -iquote Editeur/includes/level_edit/ -iquote Editeur/includes/system_save/ -c Editeur/editeur.c -o obj/editeur.o
obj/level.o: includes/level/level.c includes/level/level.h \
 includes/liste/liste.h includes/objet/objet.h includes/utils/utils.h \
 includes/utils/constants.h includes/utils/st_benchmark.h
	@echo "Create obj/level.o..."
	@gcc -Wall -O3 -iquote includes/ -iquote Client/includes/ -iquote Editeur/includes/ -iquote Serveur/includes/ -iquote includes/level/ -iquote includes/liste/ -iquote includes/objet/ -iquote includes/utils/ -iquote Client/includes/client_gui/ -iquote Client/includes/level_update/ -iquote Editeur/includes/editor_gui/ -iquote Editeur/includes/level_edit/ -iquote Editeur/includes/system_save/ -c includes/level/level.c -o obj/level.o
obj/utils.o: includes/utils/utils.c includes/utils/utils.h \
 includes/utils/constants.h includes/utils/st_benchmark.h
	@echo "Create obj/utils.o..."
	@gcc -Wall -O3 -iquote includes/ -iquote Client/includes/ -iquote Editeur/includes/ -iquote Serveur/includes/ -iquote includes/level/ -iquote includes/liste/ -iquote includes/objet/ -iquote includes/utils/ -iquote Client/includes/client_gui/ -iquote Client/includes/level_update/ -iquote Editeur/includes/editor_gui/ -iquote Editeur/includes/level_edit/ -iquote Editeur/includes/system_save/ -c includes/utils/utils.c -o obj/utils.o
obj/liste.o: includes/liste/liste.c includes/liste/liste.h \
 includes/objet/objet.h includes/utils/utils.h includes/utils/constants.h \
 includes/utils/st_benchmark.h
	@echo "Create obj/liste.o..."
	@gcc -Wall -O3 -iquote includes/ -iquote Client/includes/ -iquote Editeur/includes/ -iquote Serveur/includes/ -iquote includes/level/ -iquote includes/liste/ -iquote includes/objet/ -iquote includes/utils/ -iquote Client/includes/client_gui/ -iquote Client/includes/level_update/ -iquote Editeur/includes/editor_gui/ -iquote Editeur/includes/level_edit/ -iquote Editeur/includes/system_save/ -c includes/liste/liste.c -o obj/liste.o
obj/objet.o: includes/objet/objet.c includes/objet/objet.h \
 includes/utils/utils.h includes/utils/constants.h \
 includes/utils/st_benchmark.h
	@echo "Create obj/objet.o..."
	@gcc -Wall -O3 -iquote includes/ -iquote Client/includes/ -iquote Editeur/includes/ -iquote Serveur/includes/ -iquote includes/level/ -iquote includes/liste/ -iquote includes/objet/ -iquote includes/utils/ -iquote Client/includes/client_gui/ -iquote Client/includes/level_update/ -iquote Editeur/includes/editor_gui/ -iquote Editeur/includes/level_edit/ -iquote Editeur/includes/system_save/ -c includes/objet/objet.c -o obj/objet.o
obj/level_update.o: Client/includes/level_update/level_update.c \
 Client/includes/level_update/level_update.h includes/level/level.h \
 includes/liste/liste.h includes/objet/objet.h includes/utils/utils.h \
 includes/utils/constants.h includes/utils/st_benchmark.h
	@echo "Create obj/level_update.o..."
	@gcc -Wall -O3 -iquote includes/ -iquote Client/includes/ -iquote Editeur/includes/ -iquote Serveur/includes/ -iquote includes/level/ -iquote includes/liste/ -iquote includes/objet/ -iquote includes/utils/ -iquote Client/includes/client_gui/ -iquote Client/includes/level_update/ -iquote Editeur/includes/editor_gui/ -iquote Editeur/includes/level_edit/ -iquote Editeur/includes/system_save/ -c Client/includes/level_update/level_update.c -o obj/level_update.o
obj/client_gui.o: Client/includes/client_gui/client_gui.c \
 Client/includes/client_gui/client_gui.h includes/level/level.h \
 includes/liste/liste.h includes/objet/objet.h includes/utils/utils.h \
 includes/utils/constants.h includes/utils/st_benchmark.h
	@echo "Create obj/client_gui.o..."
	@gcc -Wall -O3 -iquote includes/ -iquote Client/includes/ -iquote Editeur/includes/ -iquote Serveur/includes/ -iquote includes/level/ -iquote includes/liste/ -iquote includes/objet/ -iquote includes/utils/ -iquote Client/includes/client_gui/ -iquote Client/includes/level_update/ -iquote Editeur/includes/editor_gui/ -iquote Editeur/includes/level_edit/ -iquote Editeur/includes/system_save/ -c Client/includes/client_gui/client_gui.c -o obj/client_gui.o
obj/editor_gui.o: Editeur/includes/editor_gui/editor_gui.c \
 Editeur/includes/editor_gui/editor_gui.h includes/level/level.h \
 includes/liste/liste.h includes/objet/objet.h includes/utils/utils.h \
 includes/utils/constants.h includes/utils/st_benchmark.h
	@echo "Create obj/editor_gui.o..."
	@gcc -Wall -O3 -iquote includes/ -iquote Client/includes/ -iquote Editeur/includes/ -iquote Serveur/includes/ -iquote includes/level/ -iquote includes/liste/ -iquote includes/objet/ -iquote includes/utils/ -iquote Client/includes/client_gui/ -iquote Client/includes/level_update/ -iquote Editeur/includes/editor_gui/ -iquote Editeur/includes/level_edit/ -iquote Editeur/includes/system_save/ -c Editeur/includes/editor_gui/editor_gui.c -o obj/editor_gui.o
obj/level_edit.o: Editeur/includes/level_edit/level_edit.c \
 Editeur/includes/level_edit/level_edit.h includes/level/level.h \
 includes/liste/liste.h includes/objet/objet.h includes/utils/utils.h \
 includes/utils/constants.h includes/utils/st_benchmark.h
	@echo "Create obj/level_edit.o..."
	@gcc -Wall -O3 -iquote includes/ -iquote Client/includes/ -iquote Editeur/includes/ -iquote Serveur/includes/ -iquote includes/level/ -iquote includes/liste/ -iquote includes/objet/ -iquote includes/utils/ -iquote Client/includes/client_gui/ -iquote Client/includes/level_update/ -iquote Editeur/includes/editor_gui/ -iquote Editeur/includes/level_edit/ -iquote Editeur/includes/system_save/ -c Editeur/includes/level_edit/level_edit.c -o obj/level_edit.o
obj/system_save.o: Editeur/includes/system_save/system_save.c \
 Editeur/includes/system_save/system_save.h includes/level/level.h \
 includes/liste/liste.h includes/objet/objet.h includes/utils/utils.h \
 includes/utils/constants.h includes/utils/st_benchmark.h
	@echo "Create obj/system_save.o..."
	@gcc -Wall -O3 -iquote includes/ -iquote Client/includes/ -iquote Editeur/includes/ -iquote Serveur/includes/ -iquote includes/level/ -iquote includes/liste/ -iquote includes/objet/ -iquote includes/utils/ -iquote Client/includes/client_gui/ -iquote Client/includes/level_update/ -iquote Editeur/includes/editor_gui/ -iquote Editeur/includes/level_edit/ -iquote Editeur/includes/system_save/ -c Editeur/includes/system_save/system_save.c -o obj/system_save.o
buildobj: obj/level.o obj/utils.o obj/liste.o obj/objet.o obj/level_update.o obj/client_gui.o obj/editor_gui.o obj/level_edit.o obj/system_save.o obj/client.o obj/editeur.o
	@echo "Build objects done"
